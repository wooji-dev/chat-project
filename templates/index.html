<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Chatbot Demo</title>
    <style>
      :root {
        --bg: #f6f8ff;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --line: #e6eaf5;
        --primary: #2d5bff;
        --shadow: 0 18px 50px rgba(15, 23, 42, 0.08);
        --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.06);
        --radius: 22px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          "Noto Sans KR", "Apple SD Gothic Neo", Helvetica, Arial,
          "Segoe UI Emoji";
        color: var(--text);
        background: radial-gradient(
            900px 450px at 10% 10%,
            rgba(45, 91, 255, 0.14),
            rgba(45, 91, 255, 0) 60%
          ),
          radial-gradient(
            850px 400px at 90% 15%,
            rgba(0, 225, 255, 0.12),
            rgba(0, 225, 255, 0) 60%
          ),
          radial-gradient(
            700px 450px at 50% 100%,
            rgba(155, 81, 224, 0.1),
            rgba(155, 81, 224, 0) 60%
          ),
          var(--bg);
        overflow: hidden;
      }
      .wrap {
        min-height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px 14px;
      }
      .panel {
        width: min(920px, 100%);
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 48px);
        max-height: calc(100vh - 48px);
        min-height: 0;
        position: relative;
      }
      .chatHeader {
        padding: 16px 18px;
        border-bottom: 1px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(8px);
        flex: 0 0 auto;
      }
      .left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }
      .pill {
        display: flex;
        gap: 6px;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #fff;
        box-shadow: var(--shadow-soft);
        font-weight: 900;
        color: var(--text);
        font-size: 12px;
        white-space: nowrap;
      }
      .led {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #cbd5e1;
      }
      .led.ok {
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
      }
      .led.bad {
        background: #ef4444;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15);
      }
      .roomTitle {
        margin: 0;
        font-size: 15px;
        letter-spacing: -0.03em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .status {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        font-size: 12.5px;
        white-space: nowrap;
      }
      .kbd {
        font-weight: 900;
        padding: 2px 7px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #fff;
        box-shadow: var(--shadow-soft);
        color: var(--text);
      }

      .messages {
        padding: 18px;
        flex: 1;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        scroll-behavior: smooth;
        min-height: 0;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        max-width: 100%;
      }
      .row.me {
        justify-content: flex-end;
      }
      .content {
        min-width: 0;
        max-width: min(720px, 86%);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .metaLine {
        display: flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 12px;
      }
      .bubble {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 11px 12px;
        line-height: 1.45;
        font-size: 13.5px;
        white-space: pre-wrap;
        word-break: break-word;
        box-shadow: var(--shadow-soft);
      }
      .row.me .bubble {
        background: linear-gradient(
          135deg,
          rgba(45, 91, 255, 1),
          rgba(0, 225, 255, 0.85)
        );
        color: #fff;
        border: 0;
        box-shadow: 0 12px 30px rgba(45, 91, 255, 0.2);
      }

      .sysRow {
        display: flex;
        justify-content: center;
        margin: 6px 0;
      }
      .sysPill {
        font-size: 12px;
        font-weight: 900;
        color: rgba(100, 116, 139, 0.95);
        background: rgba(230, 234, 245, 0.65);
        border: 1px solid rgba(230, 234, 245, 0.95);
        padding: 7px 10px;
        border-radius: 999px;
        backdrop-filter: blur(6px);
      }

      .composer {
        padding: 14px;
        border-top: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(10px);
        flex: 0 0 auto;
      }
      .bar {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px;
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #fff;
        box-shadow: var(--shadow-soft);
      }
      .bar textarea {
        flex: 1;
        border: 0;
        outline: none;
        resize: none;
        font-size: 13.5px;
        line-height: 1.35;
        min-height: 22px;
        max-height: 140px;
        padding: 4px 2px;
        font-family: inherit;
      }
      .btn {
        border: 0;
        border-radius: 16px;
        padding: 10px 12px;
        font-weight: 900;
        font-size: 13px;
        cursor: pointer;
        background: var(--primary);
        color: #fff;
        box-shadow: 0 14px 30px rgba(45, 91, 255, 0.22);
        display: flex;
        gap: 8px;
        align-items: center;
        transition: transform 0.06s ease, filter 0.12s ease;
        user-select: none;
        white-space: nowrap;
      }
      .btn:active {
        transform: translateY(1px);
        filter: brightness(0.98);
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      #toBottom {
        position: absolute;
        right: 16px;
        bottom: 92px;
        border: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(8px);
        box-shadow: var(--shadow-soft);
        border-radius: 999px;
        padding: 10px 12px;
        font-weight: 900;
        cursor: pointer;
        display: none;
        align-items: center;
        gap: 8px;
        color: var(--text);
      }
      #toBottom:active {
        transform: translateY(1px);
      }
      #toBottom .dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: rgba(45, 91, 255, 0.95);
        box-shadow: 0 0 0 4px rgba(45, 91, 255, 0.12);
      }

      /* JSON 보기 좋게 */
      .bubble code,
      .bubble pre {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12.5px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <main class="panel">
        <div class="chatHeader">
          <div class="left">
            <div class="pill" title="WebSocket 상태">
              <span class="led bad" id="wsLed"></span>
              <span id="wsText">연결 전</span>
            </div>
            <h2 class="roomTitle">AI 챗봇 (원문 JSON 출력)</h2>
          </div>
          <div class="status">
            <span class="kbd">/ws</span>
          </div>
        </div>

        <div class="messages" id="messages" aria-live="polite"></div>

        <button id="toBottom" type="button" title="맨 아래로">
          <span class="dot"></span>
          <span>아래로</span>
          <span aria-hidden="true">↓</span>
        </button>

        <div class="composer">
          <div class="bar">
            <textarea
              id="input"
              placeholder="메시지 입력… (Enter: 전송 / Shift+Enter: 줄바꿈)"
            ></textarea>
            <button class="btn" id="sendBtn" type="button" disabled>
              <span>전송</span>
              <span aria-hidden="true">➜</span>
            </button>
          </div>
        </div>
      </main>
    </div>

    <script>
      const wsLed = document.getElementById("wsLed");
      const wsText = document.getElementById("wsText");
      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("sendBtn");
      const toBottomBtn = document.getElementById("toBottom");

      // 보기 좋게 포맷할지(들여쓰기) vs 완전 원문 출력
      const PRETTY_PRINT = true;

      function setWsState(ok, text) {
        wsLed.classList.toggle("ok", ok);
        wsLed.classList.toggle("bad", !ok);
        wsText.textContent = text;
        sendBtn.disabled = !ok;
      }

      function escapeHtml(s) {
        return (s ?? "").toString().replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }

      function nowTime() {
        const d = new Date();
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
      }

      function isNearBottom() {
        const threshold = 140;
        return (
          messagesEl.scrollHeight -
            (messagesEl.scrollTop + messagesEl.clientHeight) <
          threshold
        );
      }

      function scrollToBottom(force = false) {
        if (force || isNearBottom())
          messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function updateToBottomButton() {
        toBottomBtn.style.display = isNearBottom() ? "none" : "flex";
      }

      messagesEl.addEventListener("scroll", updateToBottomButton);
      toBottomBtn.addEventListener("click", () => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
        updateToBottomButton();
        inputEl.focus();
      });

      function addSystem(text) {
        const row = document.createElement("div");
        row.className = "sysRow";
        row.innerHTML = `<div class="sysPill">${escapeHtml(text)}</div>`;
        messagesEl.appendChild(row);
        scrollToBottom(false);
        updateToBottomButton();
      }

      function addBubble({ text, who }) {
        const time = nowTime();
        const row = document.createElement("div");
        row.className = "row" + (who === "me" ? " me" : "");

        const content = document.createElement("div");
        content.className = "content";

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        // JSON 원문을 표시할 때는 code/pre 느낌으로
        bubble.innerHTML = `<pre style="margin:0;white-space:pre-wrap;">${escapeHtml(
          text
        )}</pre>`;

        const meta = document.createElement("div");
        meta.className = "metaLine";

        if (who === "me") {
          meta.style.justifyContent = "flex-end";
          meta.innerHTML = `<span style="font-weight:900; color: rgba(45,91,255,.75);">나</span><span>·</span><span>${time}</span>`;
          content.appendChild(bubble);
          content.appendChild(meta);
        } else {
          meta.innerHTML = `<span style="font-weight:900; color: var(--text);">봇 응답</span><span>·</span><span>${time}</span>`;
          content.appendChild(meta);
          content.appendChild(bubble);
        }

        row.appendChild(content);
        messagesEl.appendChild(row);
        scrollToBottom(false);
        updateToBottomButton();
      }

      function safeParse(raw) {
        try {
          return JSON.parse(raw);
        } catch {
          return null;
        }
      }

      // Lambda 프록시 응답이면 body가 JSON 문자열일 수 있으니, 그 경우 body만 따로 파싱해서 보기좋게 붙여줌
      function normalizeRawBotResponse(rawText) {
        const outer = safeParse(rawText);
        if (!outer || typeof outer !== "object") {
          // JSON이 아니면 그대로
          return rawText;
        }

        if (!PRETTY_PRINT) {
          // 원문 JSON 문자열 그대로(outer가 이미 parsed라서 원문 유지 불가 -> rawText를 그대로 반환)
          return rawText;
        }

        const clone = { ...outer };

        // body가 JSON 문자열이면 파싱해준다(가독성용)
        if (typeof clone.body === "string") {
          const inner = safeParse(clone.body);
          if (inner && typeof inner === "object") {
            // bodyParsed를 추가하고, body는 원문도 유지하려면 그대로 두되 bodyParsed를 붙임
            clone.bodyParsed = inner;
          }
        }

        return JSON.stringify(clone, null, 2);
      }

      // ====== IME ======
      let composing = false;
      inputEl.addEventListener("compositionstart", () => (composing = true));
      inputEl.addEventListener("compositionend", () => (composing = false));

      let lastSendAt = 0;
      const SEND_DEBOUNCE_MS = 200;

      inputEl.addEventListener("input", () => {
        inputEl.style.height = "auto";
        inputEl.style.height = Math.min(inputEl.scrollHeight, 140) + "px";
      });

      // ====== WebSocket ======
      const scheme = location.protocol === "https:" ? "wss" : "ws";
      const wsUrl = `${scheme}://${location.host}/ws`;
      let ws;

      function connect() {
        setWsState(false, "연결 중…");
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          setWsState(true, "연결됨");
          addSystem("연결되었습니다. Lambda 원문 JSON을 그대로 출력합니다.");
        };
        ws.onclose = () => {
          setWsState(false, "연결 끊김");
          addSystem("연결이 끊겼습니다. 새로고침하거나 서버를 확인하세요.");
        };
        ws.onerror = () => {
          setWsState(false, "연결 오류");
          addSystem("연결 오류가 발생했습니다.");
        };

        ws.onmessage = (ev) => {
          const raw = (ev.data ?? "").toString();
          const msg = safeParse(raw);

          // 서버 프로토콜: {type, role, message}
          if (msg && typeof msg === "object" && msg.type) {
            if (msg.type === "typing") {
              addSystem(msg.message || "봇이 입력 중입니다…");
              return;
            }
            if (msg.type === "error") {
              addSystem(msg.message || "오류");
              return;
            }
            if (msg.type === "message") {
              // msg.message는 "봇 API 응답 원문(text)"이 온다
              const normalized = normalizeRawBotResponse(msg.message || "");
              addBubble({ text: normalized, who: "bot" });
              return;
            }
          }

          // 예외: 그냥 문자열로 오면 그대로 출력
          addBubble({ text: raw, who: "bot" });
        };

        setTimeout(() => {
          messagesEl.scrollTop = messagesEl.scrollHeight;
          updateToBottomButton();
        }, 0);
      }

      function sendChat() {
        if (composing) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        const text = (inputEl.value || "").trim();
        if (!text) return;

        const now = Date.now();
        if (now - lastSendAt < SEND_DEBOUNCE_MS) return;
        lastSendAt = now;

        // 사용자 입력도 그대로 표시(원하면 plain으로 바꿔도 됨)
        addBubble({ text, who: "me" });

        // 서버로는 {"message": "..."} 고정
        ws.send(JSON.stringify({ message: text }));

        inputEl.value = "";
        inputEl.style.height = "auto";
        inputEl.focus();
      }

      sendBtn.addEventListener("click", sendChat);
      inputEl.addEventListener("keydown", (e) => {
        if (e.isComposing || composing || e.keyCode === 229) return;
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendChat();
        }
      });

      connect();
    </script>
  </body>
</html>
