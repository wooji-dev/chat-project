<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat Demo</title>
    <style>
      :root {
        --bg: #f6f8ff;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --line: #e6eaf5;
        --primary: #2d5bff; /* 토스 느낌: 선명한 블루 */
        --primary-weak: #eaf0ff;
        --shadow: 0 18px 50px rgba(15, 23, 42, 0.08);
        --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.06);
        --radius: 22px;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          "Noto Sans KR", "Apple SD Gothic Neo", Helvetica, Arial,
          "Segoe UI Emoji";
        color: var(--text);
        background: radial-gradient(
            900px 450px at 10% 10%,
            rgba(45, 91, 255, 0.14),
            rgba(45, 91, 255, 0) 60%
          ),
          radial-gradient(
            850px 400px at 90% 15%,
            rgba(0, 225, 255, 0.12),
            rgba(0, 225, 255, 0) 60%
          ),
          radial-gradient(
            700px 450px at 50% 100%,
            rgba(155, 81, 224, 0.1),
            rgba(155, 81, 224, 0) 60%
          ),
          var(--bg);
        overflow-x: hidden;
      }

      .wrap {
        min-height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 28px 16px;
      }

      .app {
        width: min(980px, 100%);
        display: grid;
        grid-template-columns: 340px 1fr;
        gap: 16px;
      }

      @media (max-width: 900px) {
        .app {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .side {
        display: flex;
        flex-direction: column;
        min-height: 560px;
      }

      .hero {
        padding: 18px 18px 16px;
        border-bottom: 1px solid var(--line);
        background: linear-gradient(
            180deg,
            rgba(45, 91, 255, 0.07),
            rgba(45, 91, 255, 0) 65%
          ),
          #fff;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo {
        width: 44px;
        height: 44px;
        border-radius: 16px;
        background: linear-gradient(
          135deg,
          rgba(45, 91, 255, 0.95),
          rgba(0, 225, 255, 0.85)
        );
        box-shadow: 0 12px 30px rgba(45, 91, 255, 0.22);
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 900;
        letter-spacing: -0.04em;
      }

      .brand h1 {
        margin: 0;
        font-size: 16px;
        letter-spacing: -0.03em;
      }
      .brand p {
        margin: 2px 0 0;
        font-size: 12.5px;
        color: var(--muted);
        line-height: 1.35;
      }

      .profile {
        margin-top: 14px;
        padding: 12px 12px;
        border-radius: 18px;
        border: 1px dashed rgba(45, 91, 255, 0.25);
        background: rgba(45, 91, 255, 0.04);
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .avatar {
        width: 46px;
        height: 46px;
        border-radius: 18px;
        display: grid;
        place-items: center;
        background: #fff;
        border: 1px solid var(--line);
        box-shadow: var(--shadow-soft);
        overflow: hidden;
        flex: 0 0 auto;
      }

      .avatar svg {
        width: 46px;
        height: 46px;
        display: block;
      }

      .profile .meta {
        min-width: 0;
        flex: 1;
      }
      .profile .meta .title {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .badge {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(45, 91, 255, 0.2);
        background: rgba(45, 91, 255, 0.08);
        color: rgba(45, 91, 255, 0.95);
        font-weight: 700;
      }
      .profile input {
        width: 100%;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 10px 12px;
        font-size: 13px;
        outline: none;
        margin-top: 8px;
        background: #fff;
      }
      .profile input:focus {
        border-color: rgba(45, 91, 255, 0.55);
        box-shadow: 0 0 0 4px rgba(45, 91, 255, 0.1);
      }

      .tips {
        padding: 14px 18px 18px;
        display: grid;
        gap: 10px;
      }
      .tip {
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 12px 12px;
        background: #fff;
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }
      .tip .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: rgba(45, 91, 255, 0.9);
        box-shadow: 0 0 0 4px rgba(45, 91, 255, 0.12);
        margin-top: 4px;
        flex: 0 0 auto;
      }
      .tip b {
        display: block;
        font-size: 13px;
        letter-spacing: -0.02em;
        margin-bottom: 2px;
      }
      .tip span {
        display: block;
        font-size: 12.5px;
        color: var(--muted);
        line-height: 1.45;
      }

      .chat {
        display: flex;
        flex-direction: column;
        min-height: 560px;
      }

      .chatHeader {
        padding: 16px 18px;
        border-bottom: 1px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(8px);
      }

      .chatHeader .left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }
      .roomTitle {
        margin: 0;
        font-size: 15px;
        letter-spacing: -0.03em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .status {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        font-size: 12.5px;
        white-space: nowrap;
      }
      .pill {
        display: flex;
        gap: 6px;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #fff;
        box-shadow: var(--shadow-soft);
        font-weight: 700;
        color: var(--text);
        font-size: 12px;
      }
      .led {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #cbd5e1;
      }
      .led.ok {
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
      }
      .led.bad {
        background: #ef4444;
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15);
      }

      .messages {
        padding: 18px;
        flex: 1;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .msgRow {
        display: flex;
        gap: 10px;
        align-items: flex-end;
        max-width: 100%;
      }
      .msgRow.me {
        justify-content: flex-end;
      }
      .msgRow.me .bubble {
        background: linear-gradient(
          135deg,
          rgba(45, 91, 255, 1),
          rgba(0, 225, 255, 0.85)
        );
        color: #fff;
        border: 0;
        box-shadow: 0 12px 30px rgba(45, 91, 255, 0.2);
      }
      .msgRow.me .metaLine {
        justify-content: flex-end;
      }
      .msgRow.me .avatarWrap {
        display: none;
      }

      .avatarWrap {
        width: 40px;
        height: 40px;
        border-radius: 16px;
        border: 1px solid var(--line);
        background: #fff;
        overflow: hidden;
        display: grid;
        place-items: center;
        box-shadow: var(--shadow-soft);
        flex: 0 0 auto;
      }
      .avatarWrap svg {
        width: 40px;
        height: 40px;
      }

      .content {
        min-width: 0;
        max-width: min(560px, 78%);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .metaLine {
        display: flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 12px;
      }

      .bubble {
        border: 1px solid var(--line);
        background: #fff;
        border-radius: 18px;
        padding: 11px 12px;
        line-height: 1.45;
        font-size: 13.5px;
        white-space: pre-wrap;
        word-break: break-word;
        box-shadow: var(--shadow-soft);
      }

      .composer {
        padding: 14px;
        border-top: 1px solid var(--line);
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(10px);
      }

      .bar {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 10px;
        border: 1px solid var(--line);
        border-radius: 18px;
        background: #fff;
        box-shadow: var(--shadow-soft);
      }

      .bar textarea {
        flex: 1;
        border: 0;
        outline: none;
        resize: none;
        font-size: 13.5px;
        line-height: 1.35;
        min-height: 22px;
        max-height: 120px;
        padding: 4px 2px;
        font-family: inherit;
      }

      .btn {
        border: 0;
        border-radius: 16px;
        padding: 10px 12px;
        font-weight: 800;
        font-size: 13px;
        cursor: pointer;
        background: var(--primary);
        color: #fff;
        box-shadow: 0 14px 30px rgba(45, 91, 255, 0.22);
        display: flex;
        gap: 8px;
        align-items: center;
        transition: transform 0.06s ease, filter 0.12s ease;
        user-select: none;
      }
      .btn:active {
        transform: translateY(1px);
        filter: brightness(0.98);
      }
      .btn:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      .hint {
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        color: var(--muted);
        font-size: 12px;
      }
      .kbd {
        font-weight: 800;
        padding: 2px 7px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #fff;
        box-shadow: var(--shadow-soft);
        color: var(--text);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="app">
        <!-- LEFT -->
        <aside class="panel side">
          <div class="hero">
            <div class="brand">
              <div class="logo">C</div>
              <div>
                <h1>Chat Demo</h1>
                <p>
                  Starlette + WebSocket + Redis broadcast<br />깔끔하게만 해도
                  “그럴듯”해진다.
                </p>
              </div>
            </div>

            <div class="profile">
              <div class="avatar" id="myAvatar"></div>
              <div class="meta">
                <div class="title">
                  <div style="font-weight: 900; letter-spacing: -0.03em">
                    내 프로필
                  </div>
                  <span class="badge">캐릭터</span>
                </div>
                <input
                  id="nickname"
                  placeholder="닉네임 (로컬 표시용, 서버로 안 보냄)"
                  maxlength="16"
                />
              </div>
            </div>
          </div>

          <div class="tips">
            <div class="tip">
              <div class="dot"></div>
              <div>
                <b>토스 느낌 UI</b>
                <span>둥근 모서리 + 부드러운 그림자 + 선명한 블루 포인트.</span>
              </div>
            </div>
            <div class="tip">
              <div class="dot"></div>
              <div>
                <b>중복 메시지 제거</b>
                <span
                  >내가 보낸 메시지는 즉시 표시하고, 서버 에코는 짧은 시간 내
                  동일 텍스트면 숨김.</span
                >
              </div>
            </div>
            <div class="tip">
              <div class="dot"></div>
              <div>
                <b>캐릭터 아바타</b>
                <span
                  >말하는 사람마다 랜덤 캐릭터. (서버가 sender 정보를 안 줘서
                  프론트에서만 처리)</span
                >
              </div>
            </div>
          </div>
        </aside>

        <!-- RIGHT -->
        <main class="panel chat">
          <div class="chatHeader">
            <div class="left">
              <div class="pill" title="WebSocket 상태">
                <span class="led bad" id="wsLed"></span>
                <span id="wsText">연결 중…</span>
              </div>
              <h2 class="roomTitle">실시간 채팅</h2>
            </div>
            <div class="status">
              <span>채널</span>
              <span class="kbd">demo</span>
            </div>
          </div>

          <div class="messages" id="messages" aria-live="polite"></div>

          <div class="composer">
            <div class="bar">
              <textarea
                id="input"
                placeholder="메시지 입력… (Enter: 전송 / Shift+Enter: 줄바꿈)"
              ></textarea>
              <button class="btn" id="sendBtn" type="button">
                <span>전송</span>
                <span aria-hidden="true">➜</span>
              </button>
            </div>
            <div class="hint">
              <span
                >내 메시지는 <span class="kbd">오른쪽</span> / 다른 메시지는
                <span class="kbd">왼쪽</span></span
              >
              <span>연결 안 되면? EB에서 Procfile부터 봐.</span>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      // ====== 캐릭터 아바타(SVG) ======
      const avatarSvgs = [
        // 햄찌
        (seed) => `
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="g${seed}" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="rgba(45,91,255,.95)"/>
              <stop offset="1" stop-color="rgba(0,225,255,.85)"/>
            </linearGradient>
          </defs>
          <rect width="64" height="64" rx="18" fill="url(#g${seed})" opacity=".12"/>
          <circle cx="32" cy="35" r="18" fill="#FFF" opacity=".95"/>
          <circle cx="24" cy="20" r="7" fill="#FFF" opacity=".95"/>
          <circle cx="40" cy="20" r="7" fill="#FFF" opacity=".95"/>
          <circle cx="26" cy="33" r="2.2" fill="#0F172A"/>
          <circle cx="38" cy="33" r="2.2" fill="#0F172A"/>
          <path d="M30 38c2 2 2 2 4 0" stroke="#0F172A" stroke-width="2" stroke-linecap="round"/>
          <path d="M24 41c2.5 2 5 3 8 3s5.5-1 8-3" stroke="rgba(45,91,255,.75)" stroke-width="2" stroke-linecap="round" fill="none"/>
          <circle cx="20" cy="36" r="3.5" fill="rgba(45,91,255,.18)"/>
          <circle cx="44" cy="36" r="3.5" fill="rgba(0,225,255,.18)"/>
        </svg>
      `,
        // 토끼
        (seed) => `
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <rect width="64" height="64" rx="18" fill="rgba(155,81,224,.10)"/>
          <path d="M22 20c-2-10 4-14 8-5" stroke="rgba(45,91,255,.55)" stroke-width="6" stroke-linecap="round"/>
          <path d="M42 20c2-10-4-14-8-5" stroke="rgba(0,225,255,.55)" stroke-width="6" stroke-linecap="round"/>
          <circle cx="32" cy="36" r="18" fill="#fff" opacity=".95"/>
          <circle cx="26" cy="35" r="2.2" fill="#0F172A"/>
          <circle cx="38" cy="35" r="2.2" fill="#0F172A"/>
          <path d="M30 40c2 2 2 2 4 0" stroke="#0F172A" stroke-width="2" stroke-linecap="round"/>
          <path d="M26 44c2 2 4 3 6 3s4-1 6-3" stroke="rgba(155,81,224,.65)" stroke-width="2" stroke-linecap="round" fill="none"/>
        </svg>
      `,
        // 고양이
        (seed) => `
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <rect width="64" height="64" rx="18" fill="rgba(45,91,255,.09)"/>
          <path d="M18 28l6-8 4 7" fill="#fff" opacity=".95"/>
          <path d="M46 28l-6-8-4 7" fill="#fff" opacity=".95"/>
          <circle cx="32" cy="38" r="18" fill="#fff" opacity=".95"/>
          <circle cx="26" cy="37" r="2.2" fill="#0F172A"/>
          <circle cx="38" cy="37" r="2.2" fill="#0F172A"/>
          <path d="M32 40l-2 2h4z" fill="#0F172A"/>
          <path d="M20 40c4 0 6 1 8 2" stroke="rgba(45,91,255,.55)" stroke-width="2" stroke-linecap="round"/>
          <path d="M44 40c-4 0-6 1-8 2" stroke="rgba(0,225,255,.55)" stroke-width="2" stroke-linecap="round"/>
        </svg>
      `,
        // 펭귄
        (seed) => `
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <rect width="64" height="64" rx="18" fill="rgba(0,225,255,.10)"/>
          <ellipse cx="32" cy="38" rx="16" ry="18" fill="#0F172A" opacity=".92"/>
          <ellipse cx="32" cy="42" rx="10" ry="12" fill="#fff" opacity=".95"/>
          <circle cx="27" cy="34" r="2.2" fill="#fff"/>
          <circle cx="37" cy="34" r="2.2" fill="#fff"/>
          <path d="M30 38h4l-2 3z" fill="rgba(255, 196, 0, .95)"/>
        </svg>
      `,
      ];

      const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
      const seed = () => Math.random().toString(16).slice(2, 7);

      // 내 아바타 고정(새로고침해도 유지)
      const myAvatarKey = "chat_demo_my_avatar";
      const myAvatarSeedKey = "chat_demo_my_avatar_seed";
      const myNickKey = "chat_demo_nick";
      const myAvatarIndex = Number(localStorage.getItem(myAvatarKey) ?? -1);
      const myAvatarSeed = localStorage.getItem(myAvatarSeedKey) ?? seed();

      const chosenIndex =
        myAvatarIndex >= 0
          ? myAvatarIndex
          : Math.floor(Math.random() * avatarSvgs.length);
      localStorage.setItem(myAvatarKey, String(chosenIndex));
      localStorage.setItem(myAvatarSeedKey, myAvatarSeed);

      document.getElementById("myAvatar").innerHTML =
        avatarSvgs[chosenIndex](myAvatarSeed);

      const nicknameEl = document.getElementById("nickname");
      nicknameEl.value = localStorage.getItem(myNickKey) ?? "";
      nicknameEl.addEventListener("input", () =>
        localStorage.setItem(myNickKey, nicknameEl.value.trim())
      );

      // ====== WebSocket ======
      const wsLed = document.getElementById("wsLed");
      const wsText = document.getElementById("wsText");
      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("input");
      const sendBtn = document.getElementById("sendBtn");

      // 같은 호스트로 ws 연결 (http->ws, https->wss)
      const scheme = location.protocol === "https:" ? "wss" : "ws";
      const wsUrl = `${scheme}://${location.host}/`;
      let ws;

      const otherAvatars = new Map(); // messageText -> svg (간단 매핑: 같은 텍스트가 반복되면 같은 캐릭터처럼 보이게)
      const getOtherAvatar = (key) => {
        if (!otherAvatars.has(key)) {
          const idx = Math.floor(Math.random() * avatarSvgs.length);
          otherAvatars.set(key, avatarSvgs[idx](seed()));
        }
        return otherAvatars.get(key);
      };

      const nowTime = () => {
        const d = new Date();
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${hh}:${mm}`;
      };

      // 내가 보낸 메시지 에코 제거용
      let lastSent = { text: "", at: 0 };

      function setWsState(ok, text) {
        wsLed.classList.toggle("ok", ok);
        wsLed.classList.toggle("bad", !ok);
        wsText.textContent = text;
        sendBtn.disabled = !ok;
      }

      function scrollToBottom() {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function escapeHtml(s) {
        return s.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      }

      function addMessage({ text, me = false }) {
        const nick = (nicknameEl.value || "나").trim();
        const time = nowTime();
        const safe = escapeHtml(text);

        const row = document.createElement("div");
        row.className = "msgRow" + (me ? " me" : "");

        const avatarWrap = document.createElement("div");
        avatarWrap.className = "avatarWrap";
        avatarWrap.innerHTML = me ? "" : getOtherAvatar(text);

        const content = document.createElement("div");
        content.className = "content";

        const meta = document.createElement("div");
        meta.className = "metaLine";
        meta.innerHTML = me
          ? `<span style="font-weight:800; color: rgba(255,255,255,.92); display:none;"></span>`
          : `<span style="font-weight:900; color: var(--text); letter-spacing:-.02em;">상대</span><span>·</span><span>${time}</span>`;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.innerHTML = safe;

        if (me) {
          // 내 메시지는 메타라인을 버블 아래로 작게 표시(토스식 깔끔함)
          meta.innerHTML = `<span style="font-weight:900; color: rgba(255,255,255,.92); display:none;"></span>`;
          const tiny = document.createElement("div");
          tiny.className = "metaLine";
          tiny.style.justifyContent = "flex-end";
          tiny.innerHTML = `<span style="font-weight:900; color: rgba(45,91,255,.75);">${escapeHtml(
            nick
          )}</span><span>·</span><span>${time}</span>`;
          content.appendChild(bubble);
          content.appendChild(tiny);
        } else {
          content.appendChild(meta);
          content.appendChild(bubble);
        }

        if (!me) row.appendChild(avatarWrap);
        row.appendChild(content);

        messagesEl.appendChild(row);
        scrollToBottom();
      }

      function connect() {
        setWsState(false, "연결 중…");
        ws = new WebSocket(wsUrl);

        ws.onopen = () => setWsState(true, "연결됨");
        ws.onclose = () => setWsState(false, "연결 끊김");
        ws.onerror = () => setWsState(false, "연결 오류");

        ws.onmessage = (ev) => {
          const text = (ev.data ?? "").toString();

          // 내가 보낸 메시지 에코면 숨김(1.2초 내 동일 텍스트)
          const isEcho =
            text === lastSent.text && Date.now() - lastSent.at < 1200;
          if (isEcho) return;

          addMessage({ text, me: false });
        };
      }

      connect();

      function send() {
        const text = (inputEl.value || "").trim();
        if (!text) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) return;

        // 내 메시지는 즉시 렌더링(UX)
        addMessage({ text, me: true });

        lastSent = { text, at: Date.now() };
        ws.send(text);
        inputEl.value = "";
        inputEl.style.height = "auto";
        inputEl.focus();
      }

      sendBtn.addEventListener("click", send);

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });

      // textarea auto-grow
      inputEl.addEventListener("input", () => {
        inputEl.style.height = "auto";
        inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
      });

      // 첫 인사(너무 시끄럽진 않게)
      addMessage({
        text: "연결되면 메시지 입력하고 Enter 치면 됨. (Shift+Enter는 줄바꿈)",
        me: false,
      });
    </script>
  </body>
</html>
